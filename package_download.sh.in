#! /bin/bash -x
#=====================================================================
# Download JDK/JRE packages
#=====================================================================
# J. Boettge <boettge@mpi-halle.mpg.de>  2017-12-07 16:32:00 +0100
#=====================================================================

echo "Downloading files form vendor..."

if [ -z "$DST" ]; then
	#fallback:
	DST="./DL"
	[ ! -d "$DST" ]  && mkdir $DST
fi

# remove trailing "/" in path:
DST=${DST%\/}
ERR=0

BASE="http://download.oracle.com/otn-pub/java/jdk"
JAVA_VER="{{JAVA_VER}}"
JAVA_BUILD="{{JAVA_BUILD}}"
HASH="{{HASH}}"

JAVAFX_VER="{{JAVAFX_VER}}"
JAVAFX_BLD="{{JAVAFX_BLD}}"
JAVAFX_HASH="{{JAVAFX_HASH}}"

CNT=0
WGET_OPTS="--progress=bar:force --max-redirect=2 --no-cookies --header \"Cookie: oraclelicense=accept-securebackup-cookie\" "
FS_THRESHOLD=10000

download()
{	
	DL_URL=$1
	[ -n "$2" ] && PACKAGE=$2 || PACKAGE=`basename $DL_URL`
	
	let "CNT++"
	echo -e "Retrieving [$PACKAGE]\n\tfrom: [${DL_URL}]";
	if [ -f "${DST}/${PACKAGE}" ]; then
		echo -e "\tfile already exists"
	else
		eval wget ${WGET_OPTS} "${DL_URL}" -O "${DST}/${PACKAGE}"
		if  [ ! -f "${DST}/${PACKAGE}" ]; then
			let "ERR+=1<<$CNT"
		else
			FILESIZE=$(stat -c%s "${DST}/${PACKAGE}")
			if [ "${FS_THRESHOLD}" -gt "${FILESIZE}" ]; then
				echo -e "*E*  file has an unusual size; assuming error page"
				rm -f "${DST}/${PACKAGE}"
				let "ERR+=1<<$CNT"
			else			
				chmod g+r "${DST}/${PACKAGE}"
			fi
		fi
	fi	
}

if [ "{{O_BASE_JAVA}}" = "java8" ]; then
	{{#ifdef_property_jre}}
	download ${BASE}/${JAVA_VER}-${JAVA_BUILD}/${HASH}/jre-${JAVA_VER}-windows-x64.exe
	download ${BASE}/${JAVA_VER}-${JAVA_BUILD}/${HASH}/jre-${JAVA_VER}-windows-i586.exe
	{{/ifdef_property_jre}}

	{{#ifdef_property_jdk}}
	download ${BASE}/${JAVA_VER}-${JAVA_BUILD}/${HASH}/jdk-${JAVA_VER}-windows-x64.exe
	download ${BASE}/${JAVA_VER}-${JAVA_BUILD}/${HASH}/jdk-${JAVA_VER}-windows-i586.exe
	download ${BASE}/${JAVA_VER}-${JAVA_BUILD}/${HASH}/jdk-${JAVA_VER}-docs-all.zip
	{{/ifdef_property_jdk}}

elif [ "{{O_BASE_JAVA}}" = "java9" ]; then	
	{{#ifdef_property_jre}}
	download ${BASE}/${JAVA_VER}+${JAVA_BUILD}/${HASH}/jre-${JAVA_VER}_windows-x64_bin.exe
	{{/ifdef_property_jre}}

	{{#ifdef_property_jdk}}
	download ${BASE}/${JAVA_VER}+${JAVA_BUILD}/${HASH}/jdk-${JAVA_VER}_windows-x64_bin.exe
	download ${BASE}/${JAVA_VER}+${JAVA_BUILD}/${HASH}/jdk-${JAVA_VER}_doc-all.zip
	{{/ifdef_property_jdk}}
fi
